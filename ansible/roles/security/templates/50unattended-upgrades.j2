// Unattended-Upgrades Configuration
// Vault Cube Golden Image - Automatic Security Updates
// Managed by Ansible

Unattended-Upgrade::Allowed-Origins {
    "${distro_id}:${distro_codename}";
    "${distro_id}:${distro_codename}-security";
    "${distro_id}ESMApps:${distro_codename}-apps-security";
    "${distro_id}ESM:${distro_codename}-infra-security";
};

// Package Blacklist - packages that should not be automatically upgraded
Unattended-Upgrade::Package-Blacklist {
    // NVIDIA drivers (require manual testing with GPU workloads)
    "nvidia-driver-*";
    "nvidia-dkms-*";
    "cuda-*";
    "libnvidia-*";

    // Docker (require careful testing)
    "docker-ce";
    "docker-ce-cli";
    "containerd.io";

    // Kernel updates (require reboot and validation)
    "linux-image-*";
    "linux-headers-*";
};

// Auto-fix interrupted dpkg/apt processes
Unattended-Upgrade::AutoFixInterruptedDpkg "true";

// Split the upgrade into smallest possible chunks
Unattended-Upgrade::MinimalSteps "true";

// Install updates on shutdown if system was busy during scheduled time
Unattended-Upgrade::InstallOnShutdown "false";

{% if unattended_upgrades_mail_report %}
// Send email report
Unattended-Upgrade::Mail "{{ unattended_upgrades_mail_to }}";
Unattended-Upgrade::MailReport "on-change";
{% else %}
// Email reporting disabled
Unattended-Upgrade::Mail "";
Unattended-Upgrade::MailReport "only-on-error";
{% endif %}

// Automatically remove unused dependencies
Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
Unattended-Upgrade::Remove-New-Unused-Dependencies "true";
Unattended-Upgrade::Remove-Unused-Dependencies "true";

{% if unattended_upgrades_auto_reboot %}
// Automatic reboot configuration
Unattended-Upgrade::Automatic-Reboot "true";
Unattended-Upgrade::Automatic-Reboot-WithUsers "false";
Unattended-Upgrade::Automatic-Reboot-Time "{{ unattended_upgrades_auto_reboot_time }}";
{% else %}
// Automatic reboot disabled
Unattended-Upgrade::Automatic-Reboot "false";
{% endif %}

// Bandwidth limit for downloads (0 = unlimited)
Acquire::http::Dl-Limit "0";

// Enable logging
Unattended-Upgrade::SyslogEnable "true";
Unattended-Upgrade::SyslogFacility "daemon";

// Verbose logging for debugging
// Unattended-Upgrade::Debug "false";

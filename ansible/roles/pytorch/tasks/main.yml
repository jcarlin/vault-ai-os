---
# ansible/roles/pytorch/tasks/main.yml

- name: Install PyTorch with CUDA support
  pip:
    name:
      - "torch=={{ pytorch_version }}"
      - "{{ 'torchvision' if pytorch_install_torchvision else omit }}"
      - "{{ 'torchaudio' if pytorch_install_torchaudio else omit }}"
    extra_args: "--index-url {{ pytorch_index_url }}"
    executable: pip3.12
  environment:
    TORCH_CUDA_ARCH_LIST: "{{ pytorch_cuda_arch_list | default('') }}"
  register: pytorch_installed

- name: Verify PyTorch installation
  shell: python3.12 -c "import torch; print(f'PyTorch {torch.__version__}'); print(f'CUDA available: {torch.cuda.is_available()}'); print(f'GPU count: {torch.cuda.device_count()}')"
  register: pytorch_check
  changed_when: false

- name: Display PyTorch configuration
  debug:
    msg: "{{ pytorch_check.stdout_lines }}"

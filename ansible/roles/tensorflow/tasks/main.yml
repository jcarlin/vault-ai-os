---
# ansible/roles/tensorflow/tasks/main.yml

# NGC Container method (recommended - avoids CUDA version issues)
- name: Pull TensorFlow NGC container
  shell: docker pull {{ tensorflow_ngc_image }}
  register: tensorflow_ngc_pull
  when: tensorflow_install_method == "ngc_container"

- name: Verify TensorFlow NGC container
  shell: >
    docker run --rm --gpus all {{ tensorflow_ngc_image }}
    python -c "import tensorflow as tf;
    print(f'TensorFlow {tf.__version__}');
    print(f'GPU devices: {len(tf.config.list_physical_devices(\"GPU\"))}')"
  register: tensorflow_ngc_check
  changed_when: false
  failed_when: false
  when: tensorflow_install_method == "ngc_container"

- name: Display TensorFlow NGC configuration
  debug:
    msg: "{{ tensorflow_ngc_check.stdout_lines }}"
  when: tensorflow_install_method == "ngc_container" and tensorflow_ngc_check.rc == 0

- name: Create TensorFlow convenience script
  copy:
    dest: /usr/local/bin/tensorflow-shell
    content: |
      #!/bin/bash
      # Launch an interactive TensorFlow shell with GPU access
      docker run --rm -it --gpus all \
        -v "$HOME:/workspace" \
        -w /workspace \
        {{ tensorflow_ngc_image }} \
        "${@:-bash}"
    mode: '0755'
  when: tensorflow_install_method == "ngc_container"

# Pip method (fallback - requires compatible CUDA version)
- name: Ensure Vault AI virtual environment exists
  command: python3.12 -m venv /opt/vault/venv --system-site-packages
  args:
    creates: /opt/vault/venv/bin/python
  when: tensorflow_install_method == "pip"

- name: Install TensorFlow via pip
  pip:
    name: "tensorflow=={{ tensorflow_version }}"
    virtualenv: /opt/vault/venv
  register: tensorflow_installed
  when: tensorflow_install_method == "pip"

- name: Verify TensorFlow pip installation
  shell: >
    /opt/vault/venv/bin/python -c "import tensorflow as tf;
    print(f'TensorFlow {tf.__version__}');
    print(f'GPU devices: {len(tf.config.list_physical_devices(\"GPU\"))}')"
  register: tensorflow_pip_check
  changed_when: false
  when: tensorflow_install_method == "pip"

- name: Display TensorFlow pip configuration
  debug:
    msg: "{{ tensorflow_pip_check.stdout_lines }}"
  when: tensorflow_install_method == "pip"

---
# ansible/roles/nvidia/defaults/main.yml
# Default variables for NVIDIA driver installation
#
# Compatibility Matrix (researched Feb 2026):
#   RTX 5090 (Blackwell, sm_120): Driver 570+, CUDA 12.8+, Kernel 6.13+, GCC 14
#   RTX 4090 (Ada Lovelace, sm_89): Driver 535+, CUDA 12.x, Kernel 6.5+
#   A100/H100 (Ampere, sm_80/90): Driver 535+, CUDA 12.x, Kernel 6.5+

# GPU Architecture Detection
# Options: auto, ada-lovelace (RTX 40), blackwell (RTX 50), ampere (A100/H100)
nvidia_gpu_architecture: "auto"

# Driver Versions by Architecture
nvidia_driver_version_ampere: "535"        # A100, H100
nvidia_driver_version_ada: "535"           # RTX 4090, RTX 4080
nvidia_driver_version_blackwell: "570"     # RTX 5090, RTX 5080 — minimum 570.26+

# Driver Type
# Options: proprietary, open
# NOTE: RTX 50 series (Blackwell) REQUIRES nvidia-open kernel modules.
#   Proprietary modules do NOT detect RTX 5090 ("No devices were found").
#   Auto-detection in detect_gpu.yml overrides this to "open" for Blackwell.
nvidia_driver_type: "open"

# CUDA Toolkit Version
# CUDA 12.8 is the first version with native Blackwell (sm_120) cubin support.
# Older CUDA versions (11.8–12.7) only support Blackwell via PTX JIT (reduced perf).
cuda_version: "12.8"
cuda_version_full: "12.8.0"

# cuDNN Version
# cuDNN 9.7.1 is compatible with CUDA 12.8 for Blackwell GPUs
cudnn_version: "9.7.1"
cudnn_version_full: "9.7.1"

# Kernel Requirements
kernel_version_minimum_ampere: "6.5"
kernel_version_minimum_ada: "6.5"
kernel_version_minimum_blackwell: "6.13"

# GCC Requirements
gcc_version_minimum_ampere: "12"
gcc_version_minimum_ada: "12"
gcc_version_minimum_blackwell: "14"

# Installation Options
nvidia_install_cuda: true
nvidia_install_cudnn: true
nvidia_enable_persistence_mode: true

# Reboot Options
nvidia_reboot_after_install: true
nvidia_reboot_timeout: 300  # seconds

# APT Repository URLs
# Updated for Ubuntu 24.04 and CUDA 12.8
nvidia_cuda_repo_url: "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64"
nvidia_cuda_repo_key_url: "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/3bf863cc.pub"

# Package Names (auto-constructed based on versions)
nvidia_driver_package_proprietary: "nvidia-driver-{{ nvidia_driver_version_selected }}"
nvidia_driver_package_open: "nvidia-driver-{{ nvidia_driver_version_selected }}-server-open"

# Kernel Package (for Blackwell architecture)
# NOTE: The exact package name depends on Ubuntu 24.04 repo availability.
# If linux-image-6.13.0-generic is not available, the upgrade_kernel.yml task
# will attempt to install from the canonical-kernel-team PPA.
nvidia_kernel_package_blackwell: "linux-image-6.13.0-generic"

# GCC Package (for Blackwell architecture)
nvidia_gcc_package_blackwell: "gcc-14"
nvidia_gxx_package_blackwell: "g++-14"

# Validation
nvidia_validate_after_install: true
nvidia_expected_gpu_count: 2  # 2x RTX 5090

# Performance Tuning
nvidia_persistence_mode: true
nvidia_power_limit: null  # Set to integer (watts) if you want to limit power

# Multi-GPU NCCL Configuration
# RTX 5090 does NOT support NVLink — multi-GPU uses PCIe only.
# P2P (peer-to-peer) GPU communication has known issues on dual RTX 5090 setups.
# Set nccl_p2p_disable to true if you encounter P2P errors or CUDA init failures.
nccl_p2p_disable: false
nccl_p2p_level: "NVL"  # Options: NVL, PHB, PIX, PXB, SYS

# CUDA architecture target for custom extensions
# sm_120 = Blackwell (RTX 5090), sm_89 = Ada Lovelace, sm_80 = Ampere
torch_cuda_arch_list: "12.0"

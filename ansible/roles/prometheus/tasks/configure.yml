---
# Deploy Prometheus configuration with all scrape targets

- name: Deploy Prometheus configuration
  template:
    src: prometheus.yml.j2
    dest: /etc/prometheus/prometheus.yml
    owner: prometheus
    group: prometheus
    mode: '0644'
    validate: "promtool check config %s"
  notify: Restart prometheus

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Enable and start Prometheus
  systemd:
    name: prometheus
    enabled: yes
    state: started
  when: not (packer_build | default(false))

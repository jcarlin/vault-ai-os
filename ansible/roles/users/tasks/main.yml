---
# Users Role - User Management and Sudo Configuration

- name: Ensure vaultadmin user exists
  user:
    name: "{{ vault_user }}"
    comment: "Vault Administrator"
    shell: /bin/bash
    create_home: yes
    state: present

- name: Add vaultadmin to sudo group
  user:
    name: "{{ vault_user }}"
    groups: sudo
    append: yes

- name: Configure scoped passwordless sudo for vaultadmin
  copy:
    content: |
      # Vault AI â€” scoped sudo for service management and updates only.
      # Full root requires the vaultadmin password (forced on first boot).
      {{ vault_user }} ALL=(ALL) NOPASSWD: /usr/bin/systemctl start vault-*, /usr/bin/systemctl stop vault-*, /usr/bin/systemctl restart vault-*, /usr/bin/systemctl status vault-*, /usr/bin/systemctl start caddy, /usr/bin/systemctl stop caddy, /usr/bin/systemctl restart caddy, /usr/bin/systemctl start vault-update-apply.service, /usr/bin/journalctl -u vault-*
    dest: "/etc/sudoers.d/{{ vault_user }}"
    mode: '0440'
    validate: 'visudo -cf %s'

- name: Force password change on first login (expire default creds)
  command: "chage -d 0 {{ vault_user }}"
  changed_when: true

- name: Set proper home directory permissions
  file:
    path: "/home/{{ vault_user }}"
    owner: "{{ vault_user }}"
    group: "{{ vault_user }}"
    mode: '0755'
    state: directory

- name: Create .ssh directory for vaultadmin
  file:
    path: "/home/{{ vault_user }}/.ssh"
    owner: "{{ vault_user }}"
    group: "{{ vault_user }}"
    mode: '0700'
    state: directory

- name: Add authorized SSH keys for vaultadmin
  authorized_key:
    user: "{{ vault_user }}"
    key: "{{ item }}"
    state: present
  loop: "{{ ssh_public_keys }}"
  when: ssh_public_keys is defined and ssh_public_keys | length > 0

- name: Disable root login
  user:
    name: root
    password: '!'
    shell: /usr/sbin/nologin
  when: disable_root_login | bool

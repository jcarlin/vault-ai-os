#cloud-config
autoinstall:
  version: 1
  interactive-sections: []
  refresh-installer:
    update: false
  identity:
    hostname: vault-cube-demo
    username: vaultadmin
    password: "$6$rounds=656000$rGzgtCEONmiYotJd$JUACpbvUX5Ur7FgAhHuwzdJvxX9KgYU8cDd/AqS6od9bXCaj1In.uqKO6ow7rTyMkk37Dz1maBPybZrEjrGKu1"
  locale: en_US.UTF-8
  keyboard:
    layout: us
  network:
    version: 2
    ethernets:
      all:
        match:
          name: "e*"
        dhcp4: true
  storage:
    layout:
      name: lvm
  ssh:
    install-server: true
    allow-pw: true
  packages:
    - openssh-server
  late-commands:
    # Create user if not exists (fallback if identity section failed)
    - curtin in-target -- bash -c 'id vaultadmin || useradd -m -s /bin/bash -G adm,sudo vaultadmin'
    - curtin in-target -- bash -c 'echo "vaultadmin:vaultadmin" | chpasswd'
    - curtin in-target -- bash -c 'echo "vaultadmin ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/vaultadmin'
    - curtin in-target -- chmod 440 /etc/sudoers.d/vaultadmin
    - curtin in-target -- sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
    - curtin in-target -- systemctl enable ssh
